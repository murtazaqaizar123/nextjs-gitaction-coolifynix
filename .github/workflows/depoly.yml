name: Deploy to Coolify

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Coolify Deployment
        run: |
          echo "Triggering deployment on Coolify..."

          # Run curl and save both body and status code
          http_response=$(mktemp)
          http_code=$(curl -s -w "%{http_code}" -o "$http_response" \
            -X POST https://www.q-solutions.pk/api/v1/deploy \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"uuid": "jgwswck8cwkock48c8w80k0c"}')

          echo "Coolify API response code: $http_code"
          echo "Coolify API response body:"
          cat "$http_response"

          # Exit if status code is not 200
          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Deployment trigger failed with status $http_code"
            exit 1
          fi
